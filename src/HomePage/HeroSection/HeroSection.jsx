import { useLayoutEffect, useRef, useEffect } from 'react';
import gsap from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';
import './HeroSection.css';

gsap.registerPlugin(ScrollTrigger);

const HeroSection = () => {
    const containerRef = useRef(null);
    const navRef = useRef(null);
    const headerRef = useRef(null);
    const framesRef = useRef([]);
    const videoFramesRef = useRef({ frame: 0 });
    const triggersRef = useRef([]);

    const FRAME_COUNT = 168;

    const getFramePath = (index) => {
        return `/frames/frame_${(index + 1).toString().padStart(5, '0')}.webp`;
    };

    // Preload images on mount
    useEffect(() => {
        framesRef.current = [];
        let loadedCount = 0;
        
        for (let i = 0; i < FRAME_COUNT; i++) {
            const img = new Image();
            img.onload = () => {
                loadedCount++;
                if (loadedCount === FRAME_COUNT) {
                    // All frames loaded - ensure first frame is visible
                    const frameElements = containerRef.current?.querySelectorAll('.hero-frame');
                    if (frameElements) {
                        frameElements.forEach((frame, index) => {
                            frame.style.visibility = index === 0 ? 'visible' : 'hidden';
                        });
                    }
                }
            };
            img.onerror = () => {
                loadedCount++;
            };
            img.src = getFramePath(i);
            framesRef.current.push(img);
        }
    }, []);

    // GSAP ScrollTrigger animations - matching Section2/Section3 approach
    useLayoutEffect(() => {
        const ctx = gsap.context(() => {
            // Main scroll trigger - pin the section like Section2/Section3
            const trigger = ScrollTrigger.create({
                trigger: containerRef.current,
                start: 'top top',
                end: () => `+=${window.innerHeight * 3.5}`,
                pin: true,
                pinSpacing: true,
                scrub: 1,

                onUpdate: (self) => {
                    const progress = self.progress;

                    // Frame animation (0-90% of scroll) - DOM-based frame switching
                    const animationProgress = Math.min(progress / 0.9, 1);
                    const targetFrame = Math.round(animationProgress * (FRAME_COUNT - 1));
                    
                    // Update frame visibility using visibility (no transition) to prevent flicker
                    const frameElements = containerRef.current.querySelectorAll('.hero-frame');
                    frameElements.forEach((frame, index) => {
                        frame.style.visibility = index === targetFrame ? 'visible' : 'hidden';
                    });

                    // Nav fade out (0-10%) - same as before
                    if (navRef.current) {
                        if (progress <= 0.1) {
                            const navProgress = progress / 0.1;
                            const opacity = 1 - navProgress;
                            gsap.set(navRef.current, { opacity });
                        } else {
                            gsap.set(navRef.current, { opacity: 0 });
                        }
                    }

                    // Header 3D animation (0-25%) - same as before
                    if (headerRef.current) {
                        if (progress <= 0.25) {
                            const zProgress = progress / 0.25;
                            const translateZ = zProgress * -500;

                            let opacity = 1;
                            if (progress >= 0.2) {
                                const fadeProgress = Math.min((progress - 0.2) / (0.25 - 0.2), 1);
                                opacity = 1 - fadeProgress;
                            }
                            gsap.set(headerRef.current, {
                                transform: `translate(-50%, -50%) translateZ(${translateZ}px)`,
                                opacity,
                            });
                        } else {
                            gsap.set(headerRef.current, { opacity: 0 });
                        }
                    }
                },
            });

            triggersRef.current.push(trigger);
        }, containerRef);

        // Force refresh like Section2 does
        ScrollTrigger.refresh();

        return () => {
            ctx.revert();
            triggersRef.current.forEach(t => t.kill());
            triggersRef.current = [];
        };
    }, []);

    return (
        <div ref={containerRef} className="hero-section">
           
            <section className="hero">
                {/* DOM-based frame animation - 116 frames stacked with visibility toggle */}
                <div className="hero-frames-container">
                    {Array.from({ length: FRAME_COUNT }, (_, i) => (
                        <img
                            key={i}
                            src={getFramePath(i)}
                            alt=""
                            className="hero-frame"
                            style={{ visibility: i === 0 ? 'visible' : 'hidden' }}
                            loading="eager"
                        />
                    ))}
                </div>

                <div className="hero-content">
                    <div ref={headerRef} className="hero-header">
                        <h1>What are you looking for?</h1>
                        <p>Trusted by</p>

                        <div className="client-logos">
                            <div className="client-logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="147" height="21" fill="currentColor">
                                    <path fillRule="evenodd"
                                        d="M51.375 10.7c0-3.29-2.555-5.906-5.932-5.906l-3.996.011a.29.29 0 0 0-.287.295v11.227a.29.29 0 0 0 .287.294h3.996c3.377 0 5.932-2.631 5.932-5.92m-4.59 3.347a3.5 3.5 0 0 1-1.342.293h-1.812V7.072h1.8119999999999998a3.4 3.4 0 0 1 2.478 1.062 3.58 3.58 0 0 1 .98 2.566 3.64 3.64 0 0 1-.994 2.555 3.5 3.5 0 0 1-1.122.792M66.353 10.7c0-3.373-2.717-6.174-6.272-6.174-3.531 0-6.25 2.788-6.25 6.174s2.695 6.174 6.25 6.174 6.272-2.801 6.272-6.174m-2.763 1.503c-.59 1.451-1.976 2.395-3.51 2.39-2.09-.01-3.778-1.75-3.778-3.893.003-1.573.929-2.99 2.346-3.588a3.72 3.72 0 0 1 4.13.852 3.96 3.96 0 0 1 .812 4.239M81.248 10.7c0-3.386-2.717-6.174-6.26-6.174-3.555 0-6.273 2.788-6.273 6.174s2.74 6.174 6.272 6.174 6.261-2.787 6.261-6.174m-2.479.003c.002 2.144-1.69 3.884-3.781 3.89a3.75 3.75 0 0 1-2.686-1.14 3.94 3.94 0 0 1-1.113-2.753c.003-2.145 1.7-3.88 3.792-3.88 2.09 0 3.785 1.737 3.788 3.883M84.797 4.805a.29.29 0 0 0-.287.295l.014 11.218a.29.29 0 0 0 .286.295h1.876a.29.29 0 0 0 .286-.295v-3.822h2.143l2.138 3.98a.29.29 0 0 0 .26.16h1.948a.28.28 0 0 0 .271-.144.3.3 0 0 0-.01-.315l-2.22-4.022c1.277-.655 2.076-2 2.058-3.463 0-2.164-1.66-3.887-3.953-3.887zm5.332 5.3q-.287.108-.593.095h-2.555V7.072h2.555v.003a1.5 1.5 0 0 1 1.122.454 1.57 1.57 0 0 1 .444 1.151 1.55 1.55 0 0 1-.468 1.102 1.5 1.5 0 0 1-.505.323M107.746 10.762c0-3.296-2.555-5.915-5.932-5.915l-3.985.013a.29.29 0 0 0-.286.296v11.227a.29.29 0 0 0 .175.27.3.3 0 0 0 .111.024h3.985c3.377 0 5.932-2.62 5.932-5.915m-4.59 3.343c-.424.186-.88.285-1.342.291h-1.811V7.128h1.812a3.4 3.4 0 0 1 2.482 1.063 3.567 3.567 0 0 1 .977 2.57 3.64 3.64 0 0 1-.995 2.554c-.318.336-.7.604-1.123.79M112.14 16.407l.918-2.588h4.44l.917 2.587a.285.285 0 0 0 .287.203h1.989a.28.28 0 0 0 .261-.123.3.3 0 0 0 .026-.294l-4.3-11.216a.285.285 0 0 0-.287-.194h-2.227a.286.286 0 0 0-.287.194l-4.3 11.216a.297.297 0 0 0 .139.392q.07.032.147.026h1.991a.29.29 0 0 0 .286-.203m1.74-4.784 1.402-3.886 1.399 3.886z"
                                        clipRule="evenodd"></path>
                                    <path
                                        d="M127.322 4.526c-2.471 0-4.037 1.606-4.037 3.463l-.001.018c0 2.455 1.971 3.056 3.623 3.559 1.191.362 2.216.675 2.216 1.595 0 .847-.814 1.523-2.049 1.523a3.64 3.64 0 0 1-2.52-1.053.284.284 0 0 0-.416 0l-1.066 1.094a.3.3 0 0 0-.093.216.3.3 0 0 0 .093.216 5.78 5.78 0 0 0 4.168 1.717c2.789 0 4.366-1.62 4.369-3.76 0-2.455-1.973-3.056-3.626-3.56-1.191-.362-2.217-.674-2.217-1.594 0-.679.731-1.267 1.72-1.267a2.86 2.86 0 0 1 1.913.773.28.28 0 0 0 .203.086.28.28 0 0 0 .203-.086l1.103-1.123a.3.3 0 0 0 0-.432 5.05 5.05 0 0 0-3.586-1.385M137.238 4.974a.3.3 0 0 1 .02.11v4.44h4.945v-4.44a.29.29 0 0 1 .283-.293h1.876a.29.29 0 0 1 .266.183.3.3 0 0 1 .02.11V16.3a.29.29 0 0 1-.286.295h-1.876a.29.29 0 0 1-.286-.295V11.79h-4.942v4.51a.29.29 0 0 1-.286.294h-1.876a.29.29 0 0 1-.286-.295V5.085a.28.28 0 0 1 .082-.206.3.3 0 0 1 .204-.088h1.876a.29.29 0 0 1 .266.183M24.017 2.384c2.768-.01 5.313 1.492 6.614 3.904v-.003c3.347 6.274-1.182 12.594-7.173 12.594h-4.604c-.57.001-1.117-.224-1.523-.624l-4.565-4.532a.705.705 0 0 1 .111-1.094.7.7 0 0 1 .398-.12h10.18c1.052-.01 1.896-.86 1.885-1.898a1.89 1.89 0 0 0-1.924-1.86H8.65c-.57 0-1.12-.224-1.522-.625L2.565 3.598a.705.705 0 0 1 .109-1.093.7.7 0 0 1 .397-.12z">
                                    </path>
                                </svg>
                            </div>

                            <div className="client-logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="125" height="42" fill="currentColor">
                                    <path
                                        d="M14.97 2.3h3.694v.696h-.696q-.182 0-.64.418c-.305.278-.458.496-.458.64v10.608q0 .218.458.64.458.42.64.42h.696v.693h-5.45v-.699h.695q.182 0 .624-.421.44-.42.44-.64V4.385L9.85 16.667 4.733 4.172v10.486q.001.22.437.64c.29.28.502.421.624.421h.692v.693H2.1v-.696h.695q.22 0 .659-.421.438-.42.436-.64V4.053q0-.216-.436-.64-.437-.419-.659-.417H2.1V2.3h4.093l4.243 10.567h.11zm8.776 12.686a3.33 3.33 0 0 0 1.791-.4 3.5 3.5 0 0 0 1.095-1.207h.587a5.3 5.3 0 0 1-1.445 2.375 3.85 3.85 0 0 1-2.686.88 3.72 3.72 0 0 1-3.036-1.392 5.1 5.1 0 0 1-1.133-3.326 4.87 4.87 0 0 1 1.277-3.548 4.13 4.13 0 0 1 3.07-1.316 4.6 4.6 0 0 1 1.828.33c.527.225 1.01.542 1.426.937l-1.332 2.093-.55.034a3.7 3.7 0 0 0-.109-1.872 1.36 1.36 0 0 0-1.463-.823 2.26 2.26 0 0 0-2.012.986 4.63 4.63 0 0 0-.659 2.599 3.9 3.9 0 0 0 .896 2.595 3.07 3.07 0 0 0 2.455 1.055m9.067 1.426H27.29v-.696h.706q.219 0 .658-.421.438-.42.437-.64V4.053q.001-.216-.437-.64c-.293-.28-.521-.417-.658-.417h-.705V2.3h5.522v.696h-.696q-.219 0-.658.418c-.293.278-.437.496-.437.64v5.778L36.067 4.2c.097-.122 0-.352-.256-.693s-.465-.511-.586-.511h-.677V2.3h5.116v.696h-.695c-.344.118-.66.306-.927.552-.49.378-.78.624-.88.715l-3.432 3.69 4.936 6.552c.24.28.516.525.82.73.246.226.54.39.862.478h1.023c.242-.05.462-.178.624-.365q.402-.369.403-.624V8.955q0-.22-.403-.587a1.13 1.13 0 0 0-.624-.365h-.552v-.695h3.254v7.422q0 .256.421.624c.162.177.37.304.602.365h1.136c.122 0 .312-.121.584-.365q.404-.365.402-.624V8.955q0-.22-.403-.587-.401-.365-.583-.365h-.587v-.695h2.89l.365 1.856a16 16 0 0 1 1.59-1.463 3.12 3.12 0 0 1 1.991-.624 2.5 2.5 0 0 1 1.813.733 2.54 2.54 0 0 1 .749 1.9v5.02q0 .256.402.624c.269.247.462.365.584.365h.586v.693h-4.789v-.696h.506a1.14 1.14 0 0 0 .624-.365c.268-.247.402-.452.402-.624V9.832a1.7 1.7 0 0 0-.368-1.133 1.34 1.34 0 0 0-1.095-.44 3.43 3.43 0 0 0-1.994.715q-1.002.711-1.001 1.188v4.568q0 .256.402.624c.163.187.382.315.624.365h.512v.693H37.356l-4.908-7.055-1.426 1.536v3.765q-.001.22.437.64.44.42.658.421h.512v.693H31.07l-.22-3.43-.22 3.43h-2.89v-.696h.506a1.14 1.14 0 0 0 .624-.365c.268-.247.402-.452.402-.624V8.955q0-.22-.403-.587a1.13 1.13 0 0 0-.624-.365h-.552v-.695h2.89z">
                                    </path>
                                </svg>
                            </div>

                            <div className="client-logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="106" height="28" fill="currentColor">
                                    <path
                                        d="M104.266 16.2H97.27c.14 1.621 1.233 2.414 2.396 2.414.758 0 1.498-.264 1.992-1.092h2.502c-.511 1.41-1.885 2.978-4.476 2.978-3.049 0-4.828-2.273-4.828-5.005 0-2.82 1.956-4.916 4.758-4.916 2.925 0 4.74 2.273 4.652 5.621m-4.67-3.842c-.916 0-2.097.564-2.29 2.168h4.493c-.053-1.604-1.181-2.168-2.203-2.168M90.999 20.271v-5.516c0-1.04-.089-2.22-1.516-2.22-1.621 0-1.886 1.357-1.886 2.802v4.934h-2.431v-5.516c0-1.04-.088-2.22-1.516-2.22-1.621 0-1.886 1.357-1.886 2.802v4.934h-2.431v-9.48h2.431v1.25c.547-.934 1.498-1.462 2.644-1.462 1.603 0 2.326.863 2.696 1.55.758-1.057 1.692-1.55 3.12-1.55 2.378 0 3.206 1.48 3.206 3.718v5.974zM74.943 16.642v-.705c-2.731.282-3.806.6-3.806 1.656 0 .688.528 1.252 1.639 1.252 1.533 0 2.167-.81 2.167-2.203m.212 2.45c-.687.986-1.674 1.41-3.102 1.41-1.815 0-3.418-1.058-3.418-2.785 0-2.238 2.502-2.908 6.238-3.33v-.16c0-1.462-.793-1.973-1.78-1.973-.934 0-1.71.476-1.762 1.533h-2.273c.193-1.868 1.709-3.242 4.158-3.242 2.238 0 4.089.987 4.089 4.176 0 .282-.036 1.569-.036 2.414 0 1.498.088 2.344.282 3.137h-2.238c-.07-.3-.105-.705-.158-1.18M68.12 10.843v2.291c-.352-.053-.652-.053-1.004-.053-1.198 0-1.991.441-1.991 2.22v4.97h-2.432v-9.48h2.396v1.656c.547-1.18 1.393-1.639 2.503-1.639.158 0 .37.018.529.035M57.119 10.79v-.528c0-2.397 1.127-2.767 3.507-2.767h.828v1.798h-.476c-1.198 0-1.427.14-1.427 1.04v.458h1.903v1.674H59.55v7.806h-2.432v-7.806h-1.34V10.79zM50.326 12.482c-1.34 0-2.291 1.075-2.291 3.066 0 1.992.952 3.049 2.29 3.049 1.34 0 2.292-1.058 2.292-3.049s-.952-3.066-2.291-3.066m0 8.018c-2.397 0-4.758-1.639-4.758-4.952 0-3.33 2.361-4.97 4.758-4.97s4.758 1.64 4.758 4.97c0 3.313-2.361 4.952-4.758 4.952M42.003 16.078H44.4c-.335 2.59-2.485 4.423-5.533 4.423-3.807 0-5.974-2.59-5.974-6.68 0-4.035 2.326-6.555 6.044-6.555 2.996 0 5.04 1.71 5.463 4.37h-2.397c-.475-1.78-1.674-2.36-3.083-2.36-1.921 0-3.42 1.585-3.42 4.546 0 3.048 1.499 4.67 3.331 4.67 1.516 0 2.75-.67 3.172-2.415">
                                    </path>
                                    <path fillOpacity="0.4"
                                        d="M12.158 3.346 3.739 8.957c-1.162.775-2.104 2.535-2.104 3.932v7.387c0 1.396.942 1.9 2.104 1.126l8.419-5.611c1.162-.775 2.104-2.535 2.104-3.932V4.472c0-1.396-.942-1.9-2.104-1.126">
                                    </path>
                                    <path
                                        d="m21.01 6.797-8.418 5.612c-1.162.774-2.104 2.534-2.104 3.931v7.387c0 1.397.942 1.901 2.104 1.127l8.419-5.612c1.162-.774 2.104-2.535 2.104-3.931V7.924c0-1.397-.942-1.901-2.104-1.127">
                                    </path>
                                </svg>
                            </div>

                            <div className="client-logo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="84" height="26" fill="currentColor">
                                    <path
                                        d="M10.345 5.1v6.441H4.428v-6.44H1.62v15.375h2.808v-6.232h5.916v6.232h2.81V5.1zm11.797 10.406a2.323 2.323 0 1 1-4.648 0V8.92H14.83v6.586a4.983 4.983 0 0 0 9.966 0V8.92h-2.654zM41.88 9.6c0-1.35.893-1.779 1.87-1.779.79 0 1.83.6 2.513 1.329l1.744-2.057C47.136 5.914 45.37 5.1 43.923 5.1c-2.89 0-4.98 1.693-4.98 4.499 0 5.206 6.363 3.553 6.363 6.467 0 .899-.873 1.692-1.871 1.692-1.576 0-2.087-.77-2.81-1.584l-1.937 2.013c1.24 1.52 2.767 2.292 4.596 2.292 2.746 0 4.955-1.713 4.955-4.391 0-5.78-6.364-3.984-6.364-6.49m39.368 8.422c-1.574 0-2.022-.681-2.022-1.724v-4.617h2.448v-2.34H79.22V6.254l-2.7 1.212v9.405c0 2.405 1.66 3.617 3.935 3.617q.537.01 1.065-.085l.66-2.426c-.298.02-.64.041-.938.041m-48.961-9.02c-1.32 0-2.24.383-3.132 1.256v-5.06h-2.667v9.38c0 3.511 2.538 5.917 5.391 5.917 3.165 0 5.949-2.448 5.949-5.745 0-3.256-2.562-5.746-5.541-5.746m-.017 8.806a3.028 3.028 0 1 1 0-6.056 3.028 3.028 0 0 1 0 6.056m28.988-3.2c0-3.303-2.778-5.746-5.949-5.746-2.852 0-5.391 2.406-5.391 5.918v9.386h2.667v-5.068c.89.872 1.812 1.256 3.13 1.256 2.98 0 5.543-2.49 5.543-5.746m-2.526-.034a3.027 3.027 0 1 1-6.055 0 3.027 3.027 0 0 1 6.055 0">
                                    </path>
                                    <path
                                        d="M69.873 8.73V6.05a2.06 2.06 0 0 0 1.19-1.86v-.062c0-1.14-.924-2.065-2.064-2.065h-.062a2.064 2.064 0 0 0-2.064 2.065v.061a2.06 2.06 0 0 0 1.19 1.86V8.73a5.85 5.85 0 0 0-2.78 1.224l-7.35-5.726q.079-.286.082-.58a2.324 2.324 0 1 0-2.328 2.322 2.3 2.3 0 0 0 1.145-.312l7.239 5.633a5.86 5.86 0 0 0 .09 6.605l-2.202 2.202a1.9 1.9 0 0 0-.55-.09 1.91 1.91 0 1 0 1.91 1.912 1.9 1.9 0 0 0-.089-.55l2.178-2.18a5.873 5.873 0 1 0 4.465-10.46m-.903 8.816a3.013 3.013 0 1 1 0-6.024 3.014 3.014 0 0 1 .003 6.023">
                                    </path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    );
};

export default HeroSection;
